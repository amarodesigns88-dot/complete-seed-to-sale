generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String           @id @default(uuid())
  parentLocationId String?
  name             String
  email            String           @unique
  phone            String?
  passwordHash     String
  status           String           @default("active")
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  AuditLogs        AuditLog[]
  Conversions      Conversion[]
  Refunds          Refund[]
  RoomMoves        RoomMove[]
  Sales            Sale[]
  Transfers        Transfer[]       @relation("UserTransfers")
  parentLocation   Location?        @relation("UserParentLocation", fields: [parentLocationId], references: [id])
  permissions      UserPermission[]
  locations        Location[]       @relation("UserLocations")
  roles            Role[]           @relation("UserRoles")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]   @relation("UserRoles")
}

model UserPermission {
  id         String   @id @default(uuid())
  userId     String
  locationId String
  modules    Json     @default("[]")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([locationId])
}

model Location {
  id                String          @id @default(uuid())
  parentLocationId  String?
  ubi               String?         @unique
  licenseNumber     String?         @unique
  name              String
  licenseType       String
  enabledModules    Json            @default("[]")
  address           String?
  status            String          @default("active")
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  deletedAt         DateTime?
  InventoryItems    InventoryItem[] @relation("LocationInventoryItems")
  parentLocation    Location?       @relation("LocationToLocation", fields: [parentLocationId], references: [id])
  childLocations    Location[]      @relation("LocationToLocation")
  Plants            Plant[]         @relation("LocationPlants")
  Rooms             Room[]          @relation("LocationRooms")
  TransfersReceived Transfer[]      @relation("ReceiverTransfers")
  TransfersSent     Transfer[]      @relation("SenderTransfers")
  parentUsers       User[]          @relation("UserParentLocation")
  users             User[]          @relation("UserLocations")
}

model Plant {
  id                 String          @id @default(uuid())
  locationId         String
  parentPlantId      String?
  strain             String
  roomId             String?
  phase              String
  barcode            String          @unique
  status             String          @default("active")
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  deletedAt          DateTime?
  harvestDate        DateTime?
  sourceInventoryId  String?
  Cures              Cure[]          @relation("PlantCures")
  Destructions       Destruction[]
  Harvests           Harvest[]       @relation("PlantHarvests")
  harvestedInventory InventoryItem[] @relation("HarvestedPlant")
  location           Location        @relation("LocationPlants", fields: [locationId], references: [id])
  parentPlant        Plant?          @relation("PlantToPlant", fields: [parentPlantId], references: [id])
  childPlants        Plant[]         @relation("PlantToPlant")
  room               Room?           @relation("RoomPlants", fields: [roomId], references: [id])
  sourceInventory    InventoryItem?  @relation("InventoryToPlantSource", fields: [sourceInventoryId], references: [id])
  RoomMoves          RoomMove[]
}

model InventoryType {
  id             String          @id @default(uuid())
  name           String          @unique
  description    String?
  category       String
  unit           String
  isSource       Boolean         @default(false)
  isWaste        Boolean         @default(false)
  canConvert     Boolean         @default(true)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  inventoryItems InventoryItem[] @relation("InventoryTypeToItems")
}

model InventoryItem {
  id                String             @id @default(uuid())
  locationId        String
  parentInventoryId String?
  harvestedPlantId  String?
  harvestId         String?
  inventoryTypeId   String?
  inventoryTypeName String?
  productName       String
  quantity          Float
  unit              String
  usableWeight      Float?
  lotId             String?
  sublotIdentifier  String?
  roomId            String?
  barcode           String             @unique
  status            String             @default("active")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deletedAt         DateTime?
  conversionInputs  ConversionInput[]  @relation("InventoryConversionInputs")
  conversionOutputs ConversionOutput[] @relation("InventoryConversionOutputs")
  Destructions      Destruction[]      @relation("InventoryDestructions")
  harvest           Harvest?           @relation("HarvestInventoryItems", fields: [harvestId], references: [id])
  harvestedPlant    Plant?             @relation("HarvestedPlant", fields: [harvestedPlantId], references: [id])
  inventoryType     InventoryType?     @relation("InventoryTypeToItems", fields: [inventoryTypeId], references: [id])
  location          Location           @relation("LocationInventoryItems", fields: [locationId], references: [id])
  parentInventory   InventoryItem?     @relation("InventoryParentChild", fields: [parentInventoryId], references: [id])
  childInventories  InventoryItem[]    @relation("InventoryParentChild")
  sourcePlants      Plant[]            @relation("InventoryToPlantSource")
  RoomMoves         RoomMove[]         @relation("InventoryRoomMoves")
  SaleItems         SaleItem[]         @relation("InventorySaleItems")
  tests             Test[]             @relation("InventoryTests")
  TransferItems     TransferItem[]     @relation("InventoryTransferItems")

  @@index([harvestId])
  @@index([harvestedPlantId])
}

model Harvest {
  id                     String          @id @default(uuid())
  plantId                String?
  batchId                String
  wetFlowerWeight        Float
  wetOtherMaterialWeight Float?
  wetWasteWeight         Float?
  harvestType            String
  isAdditionalCollection Boolean         @default(false)
  status                 String          @default("active")
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  deletedAt              DateTime?
  notes                  String?
  Cures                  Cure[]          @relation("HarvestCures")
  plant                  Plant?          @relation("PlantHarvests", fields: [plantId], references: [id])
  inventoryItems         InventoryItem[] @relation("HarvestInventoryItems")
}

model Cure {
  id                     String   @id @default(uuid())
  plantId                String
  harvestId              String
  dryFlowerWeight        Float
  dryOtherMaterialWeight Float
  dryWasteWeight         Float
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  harvest                Harvest  @relation("HarvestCures", fields: [harvestId], references: [id])
  plant                  Plant    @relation("PlantCures", fields: [plantId], references: [id])
}

model Destruction {
  id                String         @id @default(uuid())
  plantId           String?
  inventoryItemId   String?
  destructionReason String
  wasteWeight       Float
  status            String         @default("active")
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  deletedAt         DateTime?
  inventoryItem     InventoryItem? @relation("InventoryDestructions", fields: [inventoryItemId], references: [id])
  plant             Plant?         @relation(fields: [plantId], references: [id])
}

model RoomMove {
  id              String         @id @default(uuid())
  plantId         String?
  inventoryItemId String?
  fromRoomId      String?
  toRoomId        String?
  moveDate        DateTime       @default(now())
  userId          String?
  status          String         @default("active")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?
  fromRoom        Room?          @relation("RoomMoveFromRoom", fields: [fromRoomId], references: [id])
  inventoryItem   InventoryItem? @relation("InventoryRoomMoves", fields: [inventoryItemId], references: [id])
  plant           Plant?         @relation(fields: [plantId], references: [id])
  toRoom          Room?          @relation("RoomMoveToRoom", fields: [toRoomId], references: [id])
  user            User?          @relation(fields: [userId], references: [id])
}

model Transfer {
  id                 String         @id @default(uuid())
  senderLocationId   String
  receiverLocationId String
  userId             String
  manifestNumber     String         @unique
  status             String         @default("pending")
  voidedAt           DateTime?
  voidReason         String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  deletedAt          DateTime?
  receiverLocation   Location       @relation("ReceiverTransfers", fields: [receiverLocationId], references: [id])
  senderLocation     Location       @relation("SenderTransfers", fields: [senderLocationId], references: [id])
  user               User           @relation("UserTransfers", fields: [userId], references: [id])
  transferItems      TransferItem[] @relation("TransferItems")
}

model TransferItem {
  id              String        @id @default(uuid())
  transferId      String
  inventoryItemId String
  quantity        Float
  status          String        @default("pending")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  inventoryItem   InventoryItem @relation("InventoryTransferItems", fields: [inventoryItemId], references: [id])
  transfer        Transfer      @relation("TransferItems", fields: [transferId], references: [id])
}

model Conversion {
  id             String             @id @default(uuid())
  userId         String?
  conversionType String
  status         String             @default("active")
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  deletedAt      DateTime?
  user           User?              @relation(fields: [userId], references: [id])
  inputs         ConversionInput[]  @relation("ConversionInputs")
  outputs        ConversionOutput[] @relation("ConversionOutputs")
}

model ConversionInput {
  id              String        @id @default(uuid())
  conversionId    String
  inventoryItemId String
  quantity        Float
  conversion      Conversion    @relation("ConversionInputs", fields: [conversionId], references: [id])
  inventoryItem   InventoryItem @relation("InventoryConversionInputs", fields: [inventoryItemId], references: [id])
}

model ConversionOutput {
  id              String        @id @default(uuid())
  conversionId    String
  inventoryItemId String
  quantity        Float
  conversion      Conversion    @relation("ConversionOutputs", fields: [conversionId], references: [id])
  inventoryItem   InventoryItem @relation("InventoryConversionOutputs", fields: [inventoryItemId], references: [id])
}

model TestingPanel {
  id            String   @id @default(uuid())
  name          String
  inventoryType String
  tests         Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  testsRelation Test[]   @relation("PanelTests")
}

model Test {
  id              String         @id @default(uuid())
  inventoryItemId String?
  panelId         String?
  result          Json?
  status          String         @default("pending")
  voidedAt        DateTime?
  voidReason      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  inventoryItem   InventoryItem? @relation("InventoryTests", fields: [inventoryItemId], references: [id])
  panel           TestingPanel?  @relation("PanelTests", fields: [panelId], references: [id])
}

model Customer {
  id                String   @id @default(uuid())
  name              String
  patientCardNumber String?
  contactInfo       Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  sales             Sale[]
}

model Sale {
  id          String     @id @default(uuid())
  customerId  String?
  userId      String?
  totalAmount Float
  status      String     @default("completed")
  voidedAt    DateTime?
  voidReason  String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  refunds     Refund[]
  customer    Customer?  @relation(fields: [customerId], references: [id])
  user        User?      @relation(fields: [userId], references: [id])
  saleItems   SaleItem[]
}

model SaleItem {
  id              String        @id @default(uuid())
  saleId          String
  inventoryItemId String
  quantity        Float
  price           Float
  discountAmount  Float         @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  inventoryItem   InventoryItem @relation("InventorySaleItems", fields: [inventoryItemId], references: [id])
  sale            Sale          @relation(fields: [saleId], references: [id])
}

model Refund {
  id           String   @id @default(uuid())
  saleId       String
  userId       String?
  refundAmount Float
  reason       String?
  createdAt    DateTime @default(now())
  sale         Sale     @relation(fields: [saleId], references: [id])
  user         User?    @relation(fields: [userId], references: [id])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  module     String
  entityType String
  entityId   String
  actionType String
  details    Json?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])
}

model Room {
  id            String     @id @default(uuid())
  locationId    String
  name          String
  roomType      String     @default("cultivation")
  status        String     @default("active")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  deletedAt     DateTime?
  createdBy     String?
  updatedBy     String?
  deletedBy     String?
  metadata      Json?
  plants        Plant[]    @relation("RoomPlants")
  location      Location   @relation("LocationRooms", fields: [locationId], references: [id])
  roomMovesFrom RoomMove[] @relation("RoomMoveFromRoom")
  roomMovesTo   RoomMove[] @relation("RoomMoveToRoom")

  @@unique([locationId, name])
  @@index([locationId])
}

model LicenseType {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  canTransfer Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
}

model Lot {
  id                 String    @id @default(uuid())
  locationId         String
  batchNumber        String    @unique
  inventoryTypeId    String
  totalQuantity      Float
  unit               String
  status             String    @default("active")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime?
  sourceInventoryIds Json?
}

model Product {
  id              String    @id @default(uuid())
  locationId      String
  name            String
  inventoryItemId String?
  category        String?
  price           Float
  discountPrice   Float?
  loyaltyPoints   Int       @default(0)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  @@index([locationId])
}

model Driver {
  id            String           @id @default(uuid())
  locationId    String
  name          String
  licenseNumber String
  status        String           @default("active")
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  deletedAt     DateTime?
  transfers     TransferDriver[]

  @@index([locationId])
}

model Vehicle {
  id           String            @id @default(uuid())
  locationId   String
  make         String
  model        String
  licensePlate String
  status       String            @default("active")
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  deletedAt    DateTime?
  transfers    TransferVehicle[]

  @@index([locationId])
}

model TransferDriver {
  id         String   @id @default(uuid())
  transferId String
  driverId   String
  createdAt  DateTime @default(now())
  driver     Driver   @relation(fields: [driverId], references: [id])

  @@index([transferId])
}

model TransferVehicle {
  id         String   @id @default(uuid())
  transferId String
  vehicleId  String
  createdAt  DateTime @default(now())
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id])

  @@index([transferId])
}

model Sample {
  id                String       @id @default(uuid())
  inventoryItemId   String
  labLocationId     String?
  sampleBarcode     String       @unique
  panelId           String?
  quantity          Float
  unit              String
  status            String       @default("pending")
  voidedAt          DateTime?
  voidReason        String?
  remediationStatus String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  deletedAt         DateTime?
  testResults       TestResult[]

  @@index([inventoryItemId])
  @@index([labLocationId])
}

model TestResult {
  id        String    @id @default(uuid())
  sampleId  String
  testName  String
  result    Json
  pass      Boolean
  coaUrl    String?
  testedBy  String?
  testedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  sample    Sample    @relation(fields: [sampleId], references: [id])

  @@index([sampleId])
}

model StateRequest {
  id          String    @id @default(uuid())
  locationId  String
  requestType String
  sampleId    String?
  description String
  status      String    @default("pending")
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([locationId])
  @@index([status])
}

model InventoryAdjustment {
  id              String    @id @default(uuid())
  inventoryItemId String
  adjustmentType  String
  quantity        Float
  reason          String
  isRedFlagged    Boolean   @default(false)
  createdBy       String
  createdAt       DateTime  @default(now())
  deletedAt       DateTime?

  @@index([inventoryItemId])
}

model InventorySplit {
  id                String    @id @default(uuid())
  parentInventoryId String
  childInventoryIds Json
  splitReason       String?
  createdBy         String
  createdAt         DateTime  @default(now())
  deletedAt         DateTime?

  @@index([parentInventoryId])
}

model InventoryCombination {
  id                 String    @id @default(uuid())
  sourceInventoryIds Json
  targetInventoryId  String?
  newInventoryId     String?
  combinationType    String
  createdBy          String
  createdAt          DateTime  @default(now())
  deletedAt          DateTime?
}
