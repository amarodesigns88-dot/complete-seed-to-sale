generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String           @id @default(uuid())
  parentLocationId String?
  parentLocation   Location?        @relation("UserParentLocation", fields: [parentLocationId], references: [id])
  permissions      UserPermission[]
  name             String
  email            String           @unique
  phone            String?
  passwordHash     String
  status           String           @default("active")
  isActive         Boolean          @default(true)
  metadata         Json?            // optional metadata for user
  lastLoginAt      DateTime?        // Track last login time

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // many-to-many relations (explicit relation names)
  roles     Role[]     @relation("UserRoles")
  locations Location[] @relation("UserLocations")

  Transfers   Transfer[]   @relation("UserTransfers")
  Conversions Conversion[]
  Sales       Sale[]
  Refunds     Refund[]
  RoomMoves   RoomMove[]
  AuditLogs   AuditLog[]
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // opposite side of the many-to-many relation with User
  users User[] @relation("UserRoles")
}

model UserPermission {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  locationId String
  modules    Json     @default("[]") // allowed modules as JSON array
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([locationId])
}

model Location {
  id                    String     @id @default(uuid())
  parentLocationId      String?
  parentLocation        Location?  @relation("LocationToLocation", fields: [parentLocationId], references: [id])
  childLocations        Location[] @relation("LocationToLocation")
  ubi                   String?    @unique
  licenseNumber         String?    @unique
  name                  String
  licenseType           String
  enabledModules        Json       @default("[]")
  address               String?
  status                String     @default("active")
  isActive              Boolean    @default(true)
  inventoryWindowStart  DateTime?
  inventoryWindowEnd    DateTime?
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  deletedAt             DateTime?

  // back-relation for users whose parentLocationId points to this Location
  parentUsers User[] @relation("UserParentLocation")

  // many-to-many for users (explicit relation name)
  users User[] @relation("UserLocations")

  Plants            Plant[]         @relation("LocationPlants")
  Rooms             Room[]          @relation("LocationRooms")
  InventoryItems    InventoryItem[] @relation("LocationInventoryItems")
  TransfersSent     Transfer[]      @relation("SenderTransfers")
  TransfersReceived Transfer[]      @relation("ReceiverTransfers")
}

model Plant {
  id            String    @id @default(uuid())
  locationId    String
  location      Location  @relation("LocationPlants", fields: [locationId], references: [id])
  parentPlantId String?
  parentPlant   Plant?    @relation("PlantToPlant", fields: [parentPlantId], references: [id])
  childPlants   Plant[]   @relation("PlantToPlant")
  strain        String
  roomId        String? // FK to Room
  room          Room?     @relation("RoomPlants", fields: [roomId], references: [id])
  phase         String
  barcode       String    @unique
  status        String    @default("active")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  harvestDate   DateTime?

  // optional link to source inventory item used to create this plant
  sourceInventoryId String?
  sourceInventory   InventoryItem? @relation("InventoryToPlantSource", fields: [sourceInventoryId], references: [id])

  // inventory items harvested from this plant
  harvestedInventory InventoryItem[] @relation("HarvestedPlant")

  Harvests     Harvest[]     @relation("PlantHarvests")
  Cures        Cure[]        @relation("PlantCures")
  Destructions Destruction[]
  RoomMoves    RoomMove[]
}

model InventoryType {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  category    String // Source, Waste, Wet, Dry, Lot, Extraction, FinishedGoods
  unit        String // e.g., "units", "grams", "kg", "lbs", "ml", "oz", "each"
  isSource    Boolean  @default(false) // true if source inventory type (clone, seed)
  isWaste     Boolean  @default(false) // true if waste type (logging only, must be destroyed)
  canConvert  Boolean  @default(true) // false for waste type
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Opposite relation to inventory items
  inventoryItems InventoryItem[] @relation("InventoryTypeToItems")
}

model InventoryItem {
  id                String          @id @default(uuid())
  locationId        String
  location          Location        @relation("LocationInventoryItems", fields: [locationId], references: [id])
  parentInventoryId String?
  parentInventory   InventoryItem?  @relation("InventoryParentChild", fields: [parentInventoryId], references: [id])
  childInventories  InventoryItem[] @relation("InventoryParentChild")

  harvestedPlantId String?
  harvestedPlant   Plant?  @relation("HarvestedPlant", fields: [harvestedPlantId], references: [id])

  harvestId String?
  harvest   Harvest? @relation("HarvestInventoryItems", fields: [harvestId], references: [id])

  inventoryTypeId   String?
  inventoryType     InventoryType? @relation("InventoryTypeToItems", fields: [inventoryTypeId], references: [id])
  inventoryTypeName String?
  productName       String
  quantity          Float
  unit              String
  price             Float?         // Price per unit
  usableWeight      Float? // For finished goods - weight that deducts from patient allotment
  lotId             String? // For items that are part of a lot
  sublotIdentifier  String? // For split inventory tracking (parent-child relationship)
  roomId            String? // Current room location for inventory
  room              Room?   @relation("InventoryItemRoom", fields: [roomId], references: [id])
  strainId          String? // Strain reference for tracking
  barcode           String         @unique
  status            String         @default("active")
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  deletedAt         DateTime?

  sourcePlants Plant[] @relation("InventoryToPlantSource")

  TransferItems TransferItem[] @relation("InventoryTransferItems")
  SaleItems     SaleItem[]     @relation("InventorySaleItems")
  Destructions  Destruction[]  @relation("InventoryDestructions")
  RoomMoves     RoomMove[]     @relation("InventoryRoomMoves")
  Samples       Sample[]       @relation("SampleInventoryItem")

  conversionInputs  ConversionInput[]  @relation("InventoryConversionInputs")
  conversionOutputs ConversionOutput[] @relation("InventoryConversionOutputs")

  tests Test[] @relation("InventoryTests")

  @@index([harvestId])
  @@index([harvestedPlantId])
}

model Harvest {
  id                     String    @id @default(uuid())
  plantId                String?
  plant                  Plant?    @relation("PlantHarvests", fields: [plantId], references: [id])
  batchId                String
  wetFlowerWeight        Float
  wetOtherMaterialWeight Float?
  wetWasteWeight         Float?
  harvestType            String
  isAdditionalCollection Boolean   @default(false)
  status                 String    @default("active")
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  deletedAt              DateTime?
  notes                  String?

  Cures          Cure[]          @relation("HarvestCures")
  inventoryItems InventoryItem[] @relation("HarvestInventoryItems")
}

model Cure {
  id                     String   @id @default(uuid())
  plantId                String
  plant                  Plant    @relation("PlantCures", fields: [plantId], references: [id])
  harvestId              String
  harvest                Harvest  @relation("HarvestCures", fields: [harvestId], references: [id])
  dryFlowerWeight        Float
  dryOtherMaterialWeight Float
  dryWasteWeight         Float
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model Destruction {
  id                String         @id @default(uuid())
  plantId           String?
  plant             Plant?         @relation(fields: [plantId], references: [id])
  inventoryItemId   String?
  inventoryItem     InventoryItem? @relation("InventoryDestructions", fields: [inventoryItemId], references: [id])
  destructionReason String
  wasteWeight       Float
  status            String         @default("active")
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  deletedAt         DateTime?
}

model RoomMove {
  id              String         @id @default(uuid())
  plantId         String?
  plant           Plant?         @relation(fields: [plantId], references: [id])
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation("InventoryRoomMoves", fields: [inventoryItemId], references: [id])

  fromRoomId String?
  fromRoom   Room?   @relation("RoomMoveFromRoom", fields: [fromRoomId], references: [id])

  toRoomId String?
  toRoom   Room?   @relation("RoomMoveToRoom", fields: [toRoomId], references: [id])

  moveDate  DateTime  @default(now())
  userId    String?
  user      User?     @relation(fields: [userId], references: [id])
  status    String    @default("active")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Transfer {
  id                 String    @id @default(uuid())
  senderLocationId   String
  senderLocation     Location  @relation("SenderTransfers", fields: [senderLocationId], references: [id])
  receiverLocationId String
  receiverLocation   Location  @relation("ReceiverTransfers", fields: [receiverLocationId], references: [id])
  userId             String
  user               User      @relation("UserTransfers", fields: [userId], references: [id])
  manifestNumber     String    @unique
  status             String    @default("pending")
  notes              String?   // optional notes for transfer
  estimatedArrival   DateTime? // estimated arrival time
  receivedAt         DateTime? // when transfer was received
  voidedAt           DateTime?
  voidReason         String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime?

  transferItems   TransferItem[]    @relation("TransferItems")
  transferDrivers TransferDriver[]
  transferVehicles TransferVehicle[]
}

model TransferItem {
  id              String        @id @default(uuid())
  transferId      String
  transfer        Transfer      @relation("TransferItems", fields: [transferId], references: [id])
  inventoryItemId String
  inventoryItem   InventoryItem @relation("InventoryTransferItems", fields: [inventoryItemId], references: [id])
  quantity        Float
  status          String        @default("pending")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model Conversion {
  id             String    @id @default(uuid())
  userId         String?
  user           User?     @relation(fields: [userId], references: [id])
  conversionType String
  status         String    @default("active")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  inputs  ConversionInput[]  @relation("ConversionInputs")
  outputs ConversionOutput[] @relation("ConversionOutputs")
}

model ConversionInput {
  id              String        @id @default(uuid())
  conversionId    String
  conversion      Conversion    @relation("ConversionInputs", fields: [conversionId], references: [id])
  inventoryItemId String
  inventoryItem   InventoryItem @relation("InventoryConversionInputs", fields: [inventoryItemId], references: [id])
  quantity        Float
}

model ConversionOutput {
  id              String        @id @default(uuid())
  conversionId    String
  conversion      Conversion    @relation("ConversionOutputs", fields: [conversionId], references: [id])
  inventoryItemId String
  inventoryItem   InventoryItem @relation("InventoryConversionOutputs", fields: [inventoryItemId], references: [id])
  quantity        Float
}

model TestingPanel {
  id            String   @id @default(uuid())
  name          String
  inventoryType String
  tests         Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  testsRelation Test[] @relation("PanelTests")
}

model Test {
  id              String         @id @default(uuid())
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation("InventoryTests", fields: [inventoryItemId], references: [id])
  panelId         String?
  panel           TestingPanel?  @relation("PanelTests", fields: [panelId], references: [id])
  result          Json?
  status          String         @default("pending")
  voidedAt        DateTime?
  voidReason      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model Customer {
  id                String   @id @default(uuid())
  name              String
  patientCardNumber String?
  contactInfo       Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  sales Sale[]
}

model Sale {
  id          String    @id @default(uuid())
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  userId      String?
  user        User?     @relation(fields: [userId], references: [id])
  totalAmount Float
  tax         Float     @default(0) // tax amount
  status      String    @default("completed")
  voidedAt    DateTime?
  voidReason  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  saleItems SaleItem[]
  refunds   Refund[]
}

model SaleItem {
  id              String        @id @default(uuid())
  saleId          String
  sale            Sale          @relation(fields: [saleId], references: [id])
  inventoryItemId String
  inventoryItem   InventoryItem @relation("InventorySaleItems", fields: [inventoryItemId], references: [id])
  quantity        Float
  price           Float
  discountAmount  Float         @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model Refund {
  id           String   @id @default(uuid())
  saleId       String
  sale         Sale     @relation(fields: [saleId], references: [id])
  userId       String?
  user         User?    @relation(fields: [userId], references: [id])
  refundAmount Float
  reason       String?
  createdAt    DateTime @default(now())
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  locationId String?  // location where action occurred
  module     String
  entityType String
  entityId   String
  actionType String
  action     String?  // specific action performed
  details    Json?
  oldValue   String?  // old value before change (JSON string)
  newValue   String?  // new value after change (JSON string)
  changes    String?  // detailed changes (JSON string)
  ipAddress  String?  // IP address of the user making the change
  metadata   Json?    // additional metadata
  createdAt  DateTime @default(now())
}

model Room {
  id         String    @id @default(uuid())
  locationId String
  location   Location  @relation("LocationRooms", fields: [locationId], references: [id])
  name       String
  roomType   String    @default("cultivation")
  status     String    @default("active")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  createdBy String? // optional userId who created
  updatedBy String? // optional userId who updated
  deletedBy String? // optional userId who deleted
  metadata  Json? // optional JSON metadata

  plants          Plant[]         @relation("RoomPlants")
  inventoryItems  InventoryItem[] @relation("InventoryItemRoom")
  roomMovesFrom   RoomMove[]      @relation("RoomMoveFromRoom")
  roomMovesTo     RoomMove[]      @relation("RoomMoveToRoom")

  @@unique([locationId, name])
  @@index([locationId])
}

// New models for complete system implementation

model LicenseType {
  id          String    @id @default(uuid())
  name        String    @unique // Cultivator, Manufacturer, Retail, Lab, etc.
  description String?
  canTransfer Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
}

model Lot {
  id                 String    @id @default(uuid())
  locationId         String
  batchNumber        String    @unique
  inventoryTypeId    String // Type of lot (Lot of Wet Flower, Lot of Dry Flower, Lot of Trim)
  totalQuantity      Float
  unit               String // lbs or kg
  status             String    @default("active")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime?
  
  // Source inventory items that make up this lot
  sourceInventoryIds Json? // Array of inventory item IDs used to create this lot
}

model Product {
  id                String    @id @default(uuid())
  locationId        String
  name              String
  inventoryItemId   String? // Link to finished goods inventory
  category          String? // Product category for retail
  price             Float
  discountPrice     Float?
  loyaltyPoints     Int       @default(0)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?
  
  @@index([locationId])
}

model Driver {
  id             String    @id @default(uuid())
  locationId     String
  name           String
  licenseNumber  String
  status         String    @default("active")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?
  
  transfers TransferDriver[]
  
  @@index([locationId])
}

model Vehicle {
  id              String    @id @default(uuid())
  locationId      String
  make            String
  model           String
  licensePlate    String
  status          String    @default("active")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  
  transfers TransferVehicle[]
  
  @@index([locationId])
}

model TransferDriver {
  id         String   @id @default(uuid())
  transferId String
  transfer   Transfer @relation(fields: [transferId], references: [id])
  driverId   String
  driver     Driver   @relation(fields: [driverId], references: [id])
  createdAt  DateTime @default(now())
  
  @@index([transferId])
}

model TransferVehicle {
  id         String   @id @default(uuid())
  transferId String
  transfer   Transfer @relation(fields: [transferId], references: [id])
  vehicleId  String
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id])
  createdAt  DateTime @default(now())
  
  @@index([transferId])
}

model Sample {
  id                String         @id @default(uuid())
  inventoryItemId   String // Inventory item sample was extracted from
  inventoryItem     InventoryItem  @relation("SampleInventoryItem", fields: [inventoryItemId], references: [id])
  labLocationId     String? // Lab assigned to test
  sampleBarcode     String    @unique
  panelId           String? // TestingPanel assigned
  quantity          Float
  unit              String
  status            String    @default("pending") // pending, sent_to_lab, testing, completed, voided
  voidedAt          DateTime?
  voidReason        String?
  remediationStatus String? // For failed tests - pending_state_approval, approved, rejected
  sampleType        String? // Type of sample
  labName           String? // Name of lab processing sample
  remediationType   String? // Type of remediation if applicable
  sampleSizeGrams   Float? // Sample size in grams
  labContactEmail   String? // Lab contact email
  remediationReason String? // Reason for remediation
  notes             String? // Additional notes
  expectedCompletionDate DateTime? // Expected completion date
  remediationNotes  String? // Notes about remediation
  assignedAt        DateTime? // Date sample was assigned to lab
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?
  
  testResults TestResult[]
  
  @@index([inventoryItemId])
  @@index([labLocationId])
}

model TestResult {
  id              String    @id @default(uuid())
  sampleId        String
  sample          Sample    @relation(fields: [sampleId], references: [id])
  testName        String
  result          Json // Test result data
  pass            Boolean
  coaUrl          String? // URL to Certificate of Analysis
  testedBy        String? // Lab technician
  testedAt        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([sampleId])
}

model StateRequest {
  id              String    @id @default(uuid())
  locationId      String // Licensee requesting
  requestType     String // remediation, etc.
  sampleId        String? // For remediation requests
  description     String
  status          String    @default("pending") // pending, approved, rejected
  reviewedBy      String? // State user ID
  reviewedAt      DateTime?
  reviewNotes     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([locationId])
  @@index([status])
}

model InventoryAdjustment {
  id              String    @id @default(uuid())
  inventoryItemId String
  adjustmentType  String // increase, decrease
  quantity        Float
  adjustmentGrams Float? // adjustment in grams
  reason          String
  isRedFlagged    Boolean   @default(false) // Warning for unusual adjustments
  createdBy       String
  createdAt       DateTime  @default(now())
  deletedAt       DateTime?
  
  @@index([inventoryItemId])
}

model InventorySplit {
  id                  String    @id @default(uuid())
  parentInventoryId   String // Original inventory item
  childInventoryIds   Json // Array of created child inventory IDs
  splitReason         String?
  createdBy           String
  createdAt           DateTime  @default(now())
  deletedAt           DateTime?
  
  @@index([parentInventoryId])
}

model InventoryCombination {
  id                   String    @id @default(uuid())
  sourceInventoryIds   Json // Array of source inventory item IDs combined
  targetInventoryId    String? // Existing inventory if combining into existing
  newInventoryId       String? // New inventory if creating new item
  combinationType      String // into_existing, create_new
  createdBy            String
  createdAt            DateTime  @default(now())
  deletedAt            DateTime?
}
